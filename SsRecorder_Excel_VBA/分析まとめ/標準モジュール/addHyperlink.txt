Option Explicit

' 設定値（必要に応じて調整）
Private Const LIST_SHEET_NAME As String = "一覧"       ' 一覧シート名
Private Const TITLE_COL As String = "A"               ' タイトルがある列
Private Const LINK_COL As String = "D"                ' ハイパーリンクを書き込む列
Private Const START_ROW As Long = 2                   ' 開始行
Private Const END_ROW As Long = 29                    ' 終了行
Private Const ANALYSIS_FOLDER As String = "タイトル別分析" ' 相対の分析フォルダ名
Private Const TARGET_SHEET As String = "メモ"          ' 開く先のシート名（不要なら空に）

Public Sub addHyperlink()
    Dim listSheet As Worksheet
    Set listSheet = thisWorkBook.Worksheets(LIST_SHEET_NAME)
    
    Dim baseFolder As String
    baseFolder = thisWorkBook.path                           ' 例: D:\Animation\演出分析
    
    Dim currentRow As Long
    For currentRow = START_ROW To END_ROW
        Dim rawTitle As String
        rawTitle = Trim$(CStr(listSheet.Cells(currentRow, TITLE_COL).Value))
        
        ' タイトル未入力はスキップ（必要ならメッセージ等に変更）
        If Len(rawTitle) = 0 Then
            ClearCellHyperlink listSheet.Cells(currentRow, LINK_COL)
            listSheet.Cells(currentRow, LINK_COL).Value = ""
            GoTo ContinueNextRow
        End If
        
        ' ファイル名用に禁止文字を除去（Windowsファイル名に使えない文字）
        Dim safeTitle As String
        safeTitle = NormalizeFileName(rawTitle)
        If Len(safeTitle) = 0 Then safeTitle = "無題"
        
        ' 相対パス（優先：.xlsm、なければ.xlsx）
        Dim relPath As String
        Dim absPath As String
        Dim fileNameOnly As String
        Dim extFound As String
        
        relPath = ANALYSIS_FOLDER & "\" & "分析メモ_" & safeTitle & ".xlsm"
        absPath = baseFolder & "\" & relPath
        If Dir$(absPath) <> "" Then
            extFound = ".xlsm"
        Else
            relPath = ANALYSIS_FOLDER & "\" & "分析メモ_" & safeTitle & ".xlsx"
            absPath = baseFolder & "\" & relPath
            If Dir$(absPath) <> "" Then
                extFound = ".xlsx"
            Else
                ' ファイル未作成の場合の表示（必要に応じて仕様変更OK）
                ClearCellHyperlink listSheet.Cells(currentRow, LINK_COL)
                listSheet.Cells(currentRow, LINK_COL).Value = "（未作成）"
                GoTo ContinueNextRow
            End If
        End If
        
        fileNameOnly = "分析メモ_" & safeTitle & extFound
        
        ' 既存リンクを消してから追加
        ClearCellHyperlink listSheet.Cells(currentRow, LINK_COL)
        
        ' SubAddress（シート内のセル）も指定したい場合： "'メモ'!A2" のように渡す
        Dim subAddr As String
        If Len(TARGET_SHEET) > 0 Then
            subAddr = "'" & TARGET_SHEET & "'!A2"         ' 必要に応じてA2→任意セルへ
        Else
            subAddr = vbNullString                         ' 省略可（ブック先頭を開く）
        End If
        
        listSheet.Hyperlinks.Add _
            Anchor:=listSheet.Cells(currentRow, LINK_COL), _
            Address:=relPath, _
            SubAddress:=subAddr, _
            TextToDisplay:=fileNameOnly & "→"
        
ContinueNextRow:
    Next currentRow
    
    listSheet.Columns(LINK_COL).AutoFit
End Sub

' 既存ハイパーリンクを安全に削除
Private Sub ClearCellHyperlink(ByVal targetCell As Range)
    On Error Resume Next
    targetCell.Hyperlinks.Delete
    On Error GoTo 0
End Sub

' Windowsのファイル名に使えない文字を除去・前後の.や空白も除去
Private Function NormalizeFileName(ByVal s As String) As String
    Dim t As String: t = Trim$(s)
    Dim badChars As Variant: badChars = Array("\", "/", ":", "*", "?", """", "<", ">", "|")
    Dim i As Long
    For i = LBound(badChars) To UBound(badChars)
        t = Replace$(t, badChars(i), "")
    Next
    Do While Len(t) > 0 And (Right$(t, 1) = "." Or Right$(t, 1) = " ")
        t = Left$(t, Len(t) - 1)
    Loop
    Do While Len(t) > 0 And (Left$(t, 1) = "." Or Left$(t, 1) = " ")
        t = Mid$(t, 2)
    Loop
    NormalizeFileName = t
End Function

